pipeline {
  agent any
  tools {
        maven 'maven-3'
        jdk 'JDK'
    }
  environment {
        DOCKERHUB_USER = "nareshbashipangu"
        IMAGE_NAME = "devops-challenge"
        BUILD_TAG = "${BUILD_NUMBER}"
        IMAGE_WITH_BUILD = "${DOCKERHUB_USER}/${IMAGE_NAME}:${BUILD_TAG}"
        IMAGE_LATEST = "${DOCKERHUB_USER}/${IMAGE_NAME}:latest"
    }
  stages {

    stage('Checkout') {
      steps {
        echo "code checkout from github"
        git branch: 'main',
            url: 'https://github.com/nareshdevops2025/devops-challenge.git'
      }
    }

     stage('Testing') {
            steps {
        dir('application') {
             echo "maven test"
                    bat 'mvn test'
                }
            }
        }

      stage('Package Build') {
            steps {
                dir('application') {
                  echo "packaging java application"
                    bat 'mvn clean package -DskipTests'
                }
            }
        }

    stage('Docker Build') {
    steps {
        dir('application') {
            echo "Building Docker image"
                bat "docker build -t %IMAGE_WITH_BUILD% ."
                     }
        }
      }

      stage('Tag Image as Latest') {
            steps {
                bat "docker tag %IMAGE_WITH_BUILD% %IMAGE_LATEST%"
            }
        }

        stage('DockerHub Login') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'dockerhub-creds',
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    bat "docker login -u %DOCKER_USER% -p %DOCKER_PASS%"
                }
            }
        }

        stage('Push Docker Images') {
            steps {
                bat """
                docker push %IMAGE_WITH_BUILD%
                docker push %IMAGE_LATEST%
                """
            }
        }

        stage('Verify Tags') {
            steps {
                bat "docker images | findstr %IMAGE_NAME%"
            }
        }
    }

    post {
        success {
            echo "✅ Docker image tagged and pushed successfully!"
        }
        failure {
            echo "❌ Docker tagging or push failed"
        }
    }
  
	  
	  }
	  
        /*stage('Docker Push') {
            steps {
                 echo "pushing Docker image to local registry"

                sh """
                    docker push ${REGISTRY}/${IMAGE_NAME}:latest
                """
            }
        }
        
 stage('Terraform Init') {
    steps {
          dir('terraform') {
            echo "terraform initialization"
              sh 'terraform init'
            }
        }
          }
    }
}
  
      stage('Terraform Init') {
            steps {
                dir('terraform') {
                    sh 'terraform init'
                }
            }
        }

      stage('Terraform Validate') {
            steps {
                dir('terraform') {
                    sh 'terraform validate'
                }
            }
        }

        stage('Terraform Plan') {
            steps {
                dir('terraform') {
                    sh 'terraform plan'
                }
            }
        }

        stage('Terraform Apply') {
            steps {
                dir('terraform') {
                    sh 'terraform apply -auto-approve'
                }
            }
        }

        stage('Verify Cluster') {
            steps {
                sh 'minikube status'
                sh 'kubectl get nodes'
            }
        }
            
   stage('SonarQube') {
      steps {
        sh 'mvn sonar:sonar'
      }
    }
  
    stage('Docker Build') {
      steps {
        sh 'docker build -t hello:latest -f docker/Dockerfile .'
      }
    }
    stage('Security Scan') {
      steps {
        sh 'trivy image hello:latest'
      }
    }
    stage('Deploy') {
      steps {
        sh 'helm upgrade --install hello helm/hello-app'
      }
    }
     
  }

 */
