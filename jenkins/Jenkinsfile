pipeline {
  agent any
	 options {
        timestamps()
    }
  tools {
        maven 'maven-3'
        jdk 'JDK'
    }
  environment {
        DOCKERHUB_USER = "nareshbashipangu"
        IMAGE_NAME = "devops-challenge"
        BUILD_TAG = "${BUILD_NUMBER}"
        IMAGE_WITH_BUILD = "${DOCKERHUB_USER}/${IMAGE_NAME}:${BUILD_TAG}"
        IMAGE_LATEST = "${DOCKERHUB_USER}/${IMAGE_NAME}:latest"
		NAMESPACE = "staging"
	    KUBECONFIG = "C:\\Users\\Hp\\.kube\\config"
    }
  stages {

	stage('Checkout') {
         steps {
          echo "Code checkout from github"
          git branch: 'main',
            url: 'https://github.com/nareshdevops2025/devops-challenge.git'
      }
    }

	stage('Testing') {
          steps {
            dir('application') {
             echo "Unit testing"
             bat 'mvn test'
                }
            }
        }

	stage('Package Build') {
            steps {
                dir('application') {
                  echo "Packaging java application"
                    bat 'mvn clean package -DskipTests'
                }
            }
        }

	stage('Docker Build') {
         steps {
             dir('application') {
               echo "Building Docker image"
               bat "docker build -t %IMAGE_WITH_BUILD% ."
                     }
        }
      }

	stage('Tag Image as Latest') {
            steps {
			    echo "Tag docker image"     
                bat "docker tag %IMAGE_WITH_BUILD% %IMAGE_LATEST%"
            }
        }

	stage('DockerHub Login') {
            steps {
				echo "Login into dockerhub"
                withCredentials([usernamePassword(
                    credentialsId: 'dockerhub-creds',
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    bat "docker login -u %DOCKER_USER% -p %DOCKER_PASS%"
                }
            }
        }

	stage('Push Docker Images') {
            steps {
     			echo "Push image into dockerhub"
                bat """
                docker push %IMAGE_WITH_BUILD%
                """
            }
        }

	stage('Verify Tags') {
              steps {
				echo "Verify image tag"
                bat "docker images | findstr %IMAGE_NAME%"
            }
        }

        stage('Verify kubectl') {
            steps {
                bat 'kubectl version --client'
            }
        }

        stage('Verify Kubernetes Context') {
            steps {
                bat 'kubectl config get-contexts'
            }
        }

        stage('Switch to Minikube Context') {
            steps {
                bat 'kubectl config use-context minikube'
            }
        }

        stage('Verify Cluster Access') {
            steps {
                bat 'kubectl get nodes'
            }
        }
    
	
	stage('Create Namespace') {
            steps {
				echo "Create namespace in Minikube"
                bat 'kubectl create namespace %NAMESPACE% --dry-run=client -o yaml | kubectl apply -f -'
                      }
        }

	stage('Deploy Application') {
            steps {
				echo "Deploy application in kubernetes namespace in Minikube"
                bat 'kubectl apply -n %NAMESPACE% -f kubernetes/deployment.yaml'
                bat 'kubectl apply -n %NAMESPACE% -f kubernetes/service.yaml'
            
            }
        }

	stage('Verify Rollout') {
            steps {
			   echo "Verify rollout"
               bat 'kubectl rollout status deployment/devops-challenge -n %NAMESPACE%'
               bat 'kubectl get pods -n %NAMESPACE%'
               bat 'kubectl get svc -n %NAMESPACE%'
            }
        }
    
   
  
	}  
	  }
